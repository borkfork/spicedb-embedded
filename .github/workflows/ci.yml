name: CI

on:
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # Build shared C library per platform; each runner uploads prebuilds for that platform (all languages).
  shared-c-lib:
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-latest
            rid: linux-x64
          - runner: ubuntu-24.04-arm
            rid: linux-arm64
          - runner: macos-latest
            rid: osx-arm64
          - runner: windows-latest
            rid: win-x64
    runs-on: ${{ matrix.runner }}
    env:
      MISE_ENABLE_TOOLS: "go"
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4

      - name: Set GOCACHE (absolute path required by Go)
        run: echo "GOCACHE=$HOME/.cache/go-build" >> $GITHUB_ENV

      - uses: jdx/mise-action@v3
        with:
          install_args: "go"

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('shared/c/go.sum', 'shared/c/go.mod') }}
          restore-keys: ${{ runner.os }}-go-

      - name: Build shared C library
        run: mise run shared-c-build

      - name: Stage prebuilds for all languages
        run: bash ./scripts/stage-all-prebuilds.sh

      - name: Upload prebuilds for this platform (all languages)
        uses: actions/upload-artifact@v4
        with:
          name: prebuilds-${{ matrix.rid }}
          path: |
            node/prebuilds
            csharp/runtimes
            java/src/main/resources/natives
            python/src/spicedb_embedded/natives
            rust/spicedb-embedded-sys/prebuilds
          retention-days: 1

  format-toml-shell:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4

      - uses: jdx/mise-action@v3
        with:
          install_args: "taplo shellcheck shfmt"

      - name: TOML and shell format check
        run: mise run format-check-toml && mise run format-check-bash

  rust:
    needs: shared-c-lib
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-latest
            rid: linux-x64
          - runner: ubuntu-24.04-arm
            rid: linux-arm64
          - runner: macos-latest
            rid: osx-arm64
          - runner: windows-latest
            rid: win-x64
    runs-on: ${{ matrix.runner }}
    env:
      MISE_ENABLE_TOOLS: "rust,github:EmbarkStudios/cargo-deny,go,github:authzed/spicedb,buf"
      # Rust tests use testcontainers (postgres, mysql, cockroach); use Linux/amd64 Docker platform.
      DOCKER_DEFAULT_PLATFORM: linux/amd64
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4

      - name: Set GOCACHE (absolute path required by Go)
        run: echo "GOCACHE=$HOME/.cache/go-build" >> $GITHUB_ENV

      - name: Login to Docker Hub (testcontainers)
        if: matrix.runner == 'ubuntu-latest' || matrix.runner == 'ubuntu-24.04-arm'
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Download prebuilds for this platform
        uses: actions/download-artifact@v4
        with:
          name: prebuilds-${{ matrix.rid }}

      - uses: jdx/mise-action@v3
        with:
          install_args: "rust github:EmbarkStudios/cargo-deny go github:authzed/spicedb buf"

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('shared/c/go.sum', 'shared/c/go.mod') }}
          restore-keys: ${{ runner.os }}-go-

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: . -> target

      - name: Format check
        run: mise run format-check-rust

      - name: Install clippy
        run: rustup component add clippy

      - name: Clippy
        run: mise run clippy

      - name: Cargo deny
        run: mise run cargo-deny

      - name: Test
        run: cargo test -p spicedb-embedded --locked

  java:
    needs: shared-c-lib
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-latest
            rid: linux-x64
          - runner: ubuntu-24.04-arm
            rid: linux-arm64
          - runner: macos-latest
            rid: osx-arm64
          - runner: windows-latest
            rid: win-x64
    runs-on: ${{ matrix.runner }}
    env:
      MISE_ENABLE_TOOLS: "java,maven"
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4

      - name: Download prebuilds for this platform
        uses: actions/download-artifact@v4
        with:
          name: prebuilds-${{ matrix.rid }}

      - uses: jdx/mise-action@v3
        with:
          install_args: "java maven"

      - uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-maven-

      - name: Set library path (Windows)
        if: matrix.runner == 'windows-latest'
        run: |
          eval "$(mise activate bash | sed 's|eval "$(mise hook-env -s bash)";|& export PATH="$(/usr/bin/cygpath -u -p "$PATH")";|')"

      - name: Format check
        run: mise run format-check-java

      - name: Compile
        working-directory: java
        run: mvn compile -q

      - name: Test
        working-directory: java
        run: mvn test

  python:
    needs: shared-c-lib
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-latest
            rid: linux-x64
          - runner: ubuntu-24.04-arm
            rid: linux-arm64
          - runner: macos-latest
            rid: osx-arm64
          - runner: windows-latest
            rid: win-x64
    runs-on: ${{ matrix.runner }}
    env:
      MISE_ENABLE_TOOLS: "python"
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4

      - name: Download prebuilds for this platform
        uses: actions/download-artifact@v4
        with:
          name: prebuilds-${{ matrix.rid }}

      - uses: jdx/mise-action@v3
        with:
          install_args: "python"

      - uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml', '**/requirements*.txt') }}
          restore-keys: ${{ runner.os }}-pip-

      - name: Set library path (Windows)
        if: matrix.runner == 'windows-latest'
        run: |
          eval "$(mise activate bash | sed 's|eval "$(mise hook-env -s bash)";|& export PATH="$(/usr/bin/cygpath -u -p "$PATH")";|')"

      - name: pip install
        working-directory: python
        run: pip install -e '.[dev]'

      - name: Format check
        working-directory: python
        run: ruff format --check .

      - name: Test
        working-directory: python
        run: pytest

  csharp:
    needs: shared-c-lib
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-latest
            rid: linux-x64
          - runner: ubuntu-24.04-arm
            rid: linux-arm64
          - runner: macos-latest
            rid: osx-arm64
          - runner: windows-latest
            rid: win-x64
    runs-on: ${{ matrix.runner }}
    env:
      MISE_ENABLE_TOOLS: "dotnet"
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4

      - name: Download prebuilds for this platform
        uses: actions/download-artifact@v4
        with:
          name: prebuilds-${{ matrix.rid }}

      - uses: jdx/mise-action@v3
        with:
          install_args: "dotnet"

      - uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: ${{ runner.os }}-nuget-

      - name: Set library path (Windows)
        if: matrix.runner == 'windows-latest'
        run: |
          eval "$(mise activate bash | sed 's|eval "$(mise hook-env -s bash)";|& export PATH="$(/usr/bin/cygpath -u -p "$PATH")";|')"

      - name: Format check
        run: mise run format-check-csharp

      - name: Test
        run: |
          dotnet build csharp/SpiceDbEmbedded.sln
          dotnet test csharp/SpiceDbEmbedded.Tests/SpiceDbEmbedded.Tests.csproj --no-build

  node:
    needs: shared-c-lib
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-latest
            rid: linux-x64
          - runner: ubuntu-24.04-arm
            rid: linux-arm64
          - runner: macos-latest
            rid: osx-arm64
          - runner: windows-latest
            rid: win-x64
    runs-on: ${{ matrix.runner }}
    env:
      MISE_ENABLE_TOOLS: "node"
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4

      - name: Download prebuilds for this platform
        uses: actions/download-artifact@v4
        with:
          name: prebuilds-${{ matrix.rid }}

      - uses: jdx/mise-action@v3
        with:
          install_args: "node"

      - uses: actions/cache@v4
        with:
          path: node/node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json', '**/package.json') }}
          restore-keys: ${{ runner.os }}-npm-

      - name: Set library path (Windows)
        if: matrix.runner == 'windows-latest'
        run: |
          eval "$(mise activate bash | sed 's|eval "$(mise hook-env -s bash)";|& export PATH="$(/usr/bin/cygpath -u -p "$PATH")";|')"

      - name: Format check
        run: mise run format-check-node

      - name: Test
        working-directory: node
        run: |
          npm ci
          npm run build
          npm test
