name: CI

on:
  pull_request:

jobs:
  # Build shared C library once and share as artifact
  shared-c-lib:
    runs-on: ubuntu-latest
    env:
      MISE_ENABLE_TOOLS: "go"
    steps:
      - uses: actions/checkout@v4

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum', '**/go.mod') }}
          restore-keys: ${{ runner.os }}-go-

      - uses: jdx/mise-action@v3
        with:
          install_args: "go"

      - name: Build shared C library
        run: mise run shared-c-build

      - name: Upload shared library
        uses: actions/upload-artifact@v4
        with:
          name: libspicedb-shared
          path: shared/c/libspicedb.*
          retention-days: 1

  rust:
    needs: shared-c-lib
    runs-on: ubuntu-latest
    env:
      MISE_ENABLE_TOOLS: "rust,cargo:cargo-deny,github:mozilla/sccache,taplo,github:knope-dev/knope,go"
      SCCACHE_GHA_ENABLED: "true"
      RUSTC_WRAPPER: "sccache"
    steps:
      - uses: actions/checkout@v4

      - name: Download shared library
        uses: actions/download-artifact@v4
        with:
          name: libspicedb-shared
          path: shared/c/

      - uses: jdx/mise-action@v3
        with:
          install_args: "rust cargo:cargo-deny github:mozilla/sccache taplo github:knope-dev/knope go"

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: . -> target

      - name: Format check
        run: mise run format-check-rust && mise run check-toml-format

      - name: Clippy
        run: mise run clippy

      - name: Cargo deny
        run: mise run cargo-deny

      - name: Test
        run: mise run rust-test

  java:
    needs: shared-c-lib
    runs-on: ubuntu-latest
    env:
      MISE_ENABLE_TOOLS: "java,maven"
    steps:
      - uses: actions/checkout@v4

      - name: Download shared library
        uses: actions/download-artifact@v4
        with:
          name: libspicedb-shared
          path: shared/c/

      - uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-maven-

      - uses: jdx/mise-action@v3
        with:
          install_args: "java maven"

      - name: Format check
        run: mise run format-check-java

      - name: Test
        working-directory: java
        run: mvn test

  python:
    needs: shared-c-lib
    runs-on: ubuntu-latest
    env:
      MISE_ENABLE_TOOLS: "python"
    steps:
      - uses: actions/checkout@v4

      - name: Download shared library
        uses: actions/download-artifact@v4
        with:
          name: libspicedb-shared
          path: shared/c/

      - uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml', '**/requirements*.txt') }}
          restore-keys: ${{ runner.os }}-pip-

      - uses: jdx/mise-action@v3
        with:
          install_args: "python"

      - name: Format check
        run: mise run format-check-python

      - name: Test
        working-directory: python
        run: |
          pip install -e ".[dev]"
          pytest

  csharp:
    needs: shared-c-lib
    runs-on: ubuntu-latest
    env:
      MISE_ENABLE_TOOLS: "dotnet"
    steps:
      - uses: actions/checkout@v4

      - name: Download shared library
        uses: actions/download-artifact@v4
        with:
          name: libspicedb-shared
          path: shared/c/

      - uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: ${{ runner.os }}-nuget-

      - uses: jdx/mise-action@v3
        with:
          install_args: "dotnet"

      - name: Format check
        run: mise run format-check-csharp

      - name: Test
        run: |
          dotnet build csharp/SpicedbEmbedded.sln
          SPICEDB_LIBRARY_PATH="$PWD/shared/c/libspicedb.$([ "$(uname)" = "Darwin" ] && echo dylib || echo so)" dotnet test csharp/SpicedbEmbedded.Tests/SpicedbEmbedded.Tests.csproj --no-build

  node:
    needs: shared-c-lib
    runs-on: ubuntu-latest
    env:
      MISE_ENABLE_TOOLS: "node"
    steps:
      - uses: actions/checkout@v4

      - name: Download shared library
        uses: actions/download-artifact@v4
        with:
          name: libspicedb-shared
          path: shared/c/

      - uses: actions/cache@v4
        with:
          path: node/node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json', '**/package.json') }}
          restore-keys: ${{ runner.os }}-npm-

      - uses: jdx/mise-action@v3
        with:
          install_args: "node"

      - name: Format check
        run: mise run format-check-node

      - name: Test
        working-directory: node
        run: |
          npm ci
          npm run build
          SPICEDB_LIBRARY_PATH="$PWD/../shared/c" npm test

  docker:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: jdx/mise-action@v3
        with:
          install: false

      - name: Docker test
        run: mise run docker-test

  # Windows: build shared library and run all language tests (verifies TCP listener path)
  shared-c-windows:
    runs-on: windows-latest
    env:
      MISE_ENABLE_TOOLS: "go"
    steps:
      - uses: actions/checkout@v4

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum', '**/go.mod') }}
          restore-keys: ${{ runner.os }}-go-

      - uses: jdx/mise-action@v3
        with:
          install_args: "go"

      - name: Build shared C library (Windows)
        shell: bash
        run: mise run shared-c-build

      - name: Upload shared library
        uses: actions/upload-artifact@v4
        with:
          name: libspicedb-shared-windows
          path: shared/c/

  windows:
    needs: shared-c-windows
    runs-on: windows-latest
    env:
      MISE_ENABLE_TOOLS: "go,rust,java,maven,python,node,dotnet,github:mozilla/sccache"
      SCCACHE_GHA_ENABLED: "true"
      RUSTC_WRAPPER: "sccache"
    steps:
      - uses: actions/checkout@v4

      - name: Download shared library
        uses: actions/download-artifact@v4
        with:
          name: libspicedb-shared-windows
          path: shared/c/

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-

      - uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-maven-

      - uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml', '**/requirements*.txt') }}
          restore-keys: ${{ runner.os }}-pip-

      - uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: ${{ runner.os }}-nuget-

      - uses: actions/cache@v4
        with:
          path: node/node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json', '**/package.json') }}
          restore-keys: ${{ runner.os }}-npm-

      - uses: jdx/mise-action@v3
        with:
          install_args: "go rust java maven python node dotnet github:mozilla/sccache"

      - name: Test all languages
        shell: bash
        run: mise run test
