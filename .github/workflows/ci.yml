name: CI

on:
  pull_request:
    branches: [main]

jobs:
  rust:
    runs-on: ubuntu-latest
    env:
      MISE_ENABLE_TOOLS: "rust,go,cargo:cargo-deny,taplo,github:knope-dev/knope"
    steps:
      - uses: actions/checkout@v4

      - uses: jdx/mise-action@v3
        with:
          install_args: "rust go cargo:cargo-deny taplo github:knope-dev/knope"

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: . -> target

      - name: Format check
        run: mise run format-check-rust && mise run check-toml-format

      - name: Clippy
        run: mise run clippy

      - name: Cargo deny
        run: mise run cargo-deny

      - name: Test
        run: mise run rust-test

  java:
    runs-on: ubuntu-latest
    env:
      MISE_ENABLE_TOOLS: "java,maven,go"
    steps:
      - uses: actions/checkout@v4

      - uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-maven-

      - uses: jdx/mise-action@v3
        with:
          install_args: "java maven go"

      - name: Format check
        run: mise run format-check-java

      - name: Test
        run: mise run java-test

  python:
    runs-on: ubuntu-latest
    env:
      MISE_ENABLE_TOOLS: "python,go"
    steps:
      - uses: actions/checkout@v4

      - uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml', '**/requirements*.txt') }}
          restore-keys: ${{ runner.os }}-pip-

      - uses: jdx/mise-action@v3
        with:
          install_args: "python go"

      - name: Format check
        run: mise run format-check-python

      - name: Test
        run: mise run python-test

  csharp:
    runs-on: ubuntu-latest
    env:
      MISE_ENABLE_TOOLS: "dotnet,go"
    steps:
      - uses: actions/checkout@v4

      - uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: ${{ runner.os }}-nuget-

      - uses: jdx/mise-action@v3
        with:
          install_args: "dotnet go"

      - name: Format check
        run: mise run format-check-csharp

      - name: Test
        run: mise run csharp-test

  node:
    runs-on: ubuntu-latest
    env:
      MISE_ENABLE_TOOLS: "node,go"
    steps:
      - uses: actions/checkout@v4

      - uses: actions/cache@v4
        with:
          path: node/node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json', '**/package.json') }}
          restore-keys: ${{ runner.os }}-npm-

      - uses: jdx/mise-action@v3
        with:
          install_args: "node go"

      - name: Format check
        run: mise run format-check-node

      - name: Test
        run: mise run node-test

  docker:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: jdx/mise-action@v3
        with:
          install: false

      - name: Docker test
        run: mise run docker-test
