# Build and publish the Rust crate to crates.io.
# Trigger: push a version tag (e.g. v0.1.0) or run manually (workflow_dispatch).
#
# Required env vars:
#   SONATYPE_USERNAME - Maven Central Portal username
# Required secrets:
#   CARGO_REGISTRY_TOKEN - crates.io API token (from https://crates.io/settings/tokens)
#   SONATYPE_TOKEN - Maven Central Portal token (from https://central.sonatype.com/usertoken)
#   GPG_PRIVATE_KEY - GPG private key for signing (no passphrase)

name: Release

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+*" # e.g. v0.1.0, v1.0.0-beta.1
  workflow_dispatch:
    inputs:
      version:
        description: "Tag to publish (e.g. v0.1.0). Must already exist."
        required: true

permissions:
  id-token: write # Required for OIDC
  contents: read

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # Build shared C library per platform for packaging with C#, Node, Java, Python
  build-shared-libs:
    defaults:
      run:
        shell: bash
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-latest
            rid: linux-x64
          - runner: macos-latest
            rid: osx-arm64
          - runner: windows-latest
            rid: win-x64
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.version || github.ref }}
          fetch-depth: 0

      - name: Set RID from runner (detect macOS arch)
        id: set_rid
        run: |
          if [[ "${{ matrix.runner }}" == macos* ]]; then
            case "$(uname -m)" in
              x86_64) rid="osx-x64" ;;
              *)      rid="osx-arm64" ;;
            esac
          else
            rid="${{ matrix.rid }}"
          fi
          echo "rid=$rid" >> $GITHUB_OUTPUT

      - uses: jdx/mise-action@v3
        with:
          install_args: "go"

      - name: Build shared C library
        run: mise run shared-c-build

      - name: Stage and upload shared lib
        run: |
          mkdir -p "out/${{ steps.set_rid.outputs.rid }}/native"
          case "${{ matrix.runner }}" in
            ubuntu*) cp shared/c/libspicedb.so "out/${{ steps.set_rid.outputs.rid }}/native/" ;;
            macos*)  cp shared/c/libspicedb.dylib "out/${{ steps.set_rid.outputs.rid }}/native/" ;;
            windows*) cp shared/c/spicedb.dll "out/${{ steps.set_rid.outputs.rid }}/native/" ;;
          esac

      - name: Upload shared lib
        uses: actions/upload-artifact@v4
        with:
          name: shared-lib-${{ steps.set_rid.outputs.rid }}
          path: out

  publish-rust:
    runs-on: ubuntu-latest
    env:
      MISE_ENABLE_TOOLS: "go,rust,github:authzed/spicedb"
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.version || github.ref }}
          fetch-depth: 0

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum', '**/go.mod') }}
          restore-keys: ${{ runner.os }}-go-

      - uses: jdx/mise-action@v3
        with:
          install_args: "go rust github:authzed/spicedb"

      - name: Build shared C library
        run: mise run shared-c-build

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: . -> target

      - name: Run tests
        run: cargo test --locked --workspace

      - name: Vendor shared/c into crate for packaging
        run: |
          mkdir -p rust/shared
          cp -r shared/c rust/shared/
          git add -f rust/shared/

      - name: Publish to crates.io
        run: cargo publish -p spicedb-embedded --token ${{ secrets.CARGO_REGISTRY_TOKEN }} --allow-dirty
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

  publish-java:
    needs: [build-shared-libs]
    runs-on: ubuntu-latest
    env:
      SONATYPE_USERNAME: ${{ vars.SONATYPE_USERNAME }}
      SONATYPE_TOKEN: ${{ secrets.SONATYPE_TOKEN }}
      GPG_PASSPHRASE: ""
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.version || github.ref }}
          fetch-depth: 0

      - name: Download shared libs for all platforms
        uses: actions/download-artifact@v4
        with:
          pattern: shared-lib-*
          path: shared-libs
          merge-multiple: true

      - name: Lay out natives for JAR
        run: |
          mkdir -p java/src/main/resources/natives/linux-x64 java/src/main/resources/natives/darwin-arm64 java/src/main/resources/natives/win32-x64
          cp shared-libs/linux-x64/native/* java/src/main/resources/natives/linux-x64/ 2>/dev/null || true
          cp shared-libs/osx-arm64/native/* java/src/main/resources/natives/darwin-arm64/ 2>/dev/null || true
          cp shared-libs/win-x64/native/* java/src/main/resources/natives/win32-x64/ 2>/dev/null || true
          ls -R java/src/main/resources/natives

      - uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2-

      - uses: jdx/mise-action@v3
        with:
          install_args: "java maven"

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"
          cache: maven
          gpg-private-key: ${{ secrets.GPG_PRIVATE_KEY }}

      - name: Configure Maven Central credentials
        run: |
          if [ -z "$SONATYPE_USERNAME" ] || [ -z "$SONATYPE_TOKEN" ]; then
            echo "::error::SONATYPE_USERNAME and SONATYPE_TOKEN secrets must be set. Create a user token at https://central.sonatype.com/usertoken and add both values as repo secrets."
            exit 1
          fi
          mkdir -p ~/.m2
          # Write actual credentials (setup-java would write ${env.VAR} literals that Maven does not expand)
          cat > ~/.m2/settings.xml << EOF
          <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
            xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
            xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0 https://maven.apache.org/xsd/settings-1.0.0.xsd">
            <servers>
              <server>
                <id>central</id>
                <username>${SONATYPE_USERNAME}</username>
                <password>${SONATYPE_TOKEN}</password>
              </server>
            </servers>
          </settings>
          EOF

      - name: Build Java library
        working-directory: java
        run: mvn -B -ntp compile

      - name: Publish to Maven Central
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          TAG="${{ github.event_name == 'workflow_dispatch' && github.event.inputs.version || github.ref_name }}"
          VERSION="${TAG#v}"
          cd java
          mvn -B -ntp versions:set -DnewVersion="$VERSION" -DgenerateBackupPoms=false
          mvn -B -ntp -P release clean deploy
          echo "Published Java $VERSION to Maven Central" >> $GITHUB_STEP_SUMMARY

  publish-npm:
    needs: [build-shared-libs]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.version || github.ref }}
          fetch-depth: 0

      - name: Download shared libs for all platforms
        uses: actions/download-artifact@v4
        with:
          pattern: shared-lib-*
          path: shared-libs
          merge-multiple: true

      - name: Lay out prebuilds for npm package
        run: |
          mkdir -p node/prebuilds/linux-x64 node/prebuilds/darwin-arm64 node/prebuilds/win32-x64
          cp shared-libs/linux-x64/native/* node/prebuilds/linux-x64/ 2>/dev/null || true
          cp shared-libs/osx-arm64/native/* node/prebuilds/darwin-arm64/ 2>/dev/null || true
          cp shared-libs/win-x64/native/* node/prebuilds/win32-x64/ 2>/dev/null || true
          ls -R node/prebuilds

      - uses: actions/cache@v4
        with:
          path: node/node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json', '**/package.json') }}
          restore-keys: ${{ runner.os }}-npm-

      - uses: jdx/mise-action@v3
        with:
          install_args: "node"

      - uses: actions/setup-node@v6
        with:
          node-version: "24"
          registry-url: "https://registry.npmjs.org"

      - name: Build Node.js package
        working-directory: node
        run: npm ci && npm run build

      - name: Publish to npm
        working-directory: node
        run: npm publish

  publish-nuget:
    needs: [build-shared-libs]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.version || github.ref }}
          fetch-depth: 0

      - name: Download shared libs for all platforms
        uses: actions/download-artifact@v4
        with:
          pattern: shared-lib-*
          path: shared-libs
          merge-multiple: true

      - name: Lay out runtimes for NuGet package
        run: |
          mkdir -p csharp/runtimes
          for dir in shared-libs/*/; do
            rid=$(basename "$dir")
            mv "$dir" "csharp/runtimes/$rid"
          done
          ls -R csharp/runtimes

      - uses: actions/cache@v4
        with:
          path: csharp/artifacts
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/bin/Release/SpiceDbEmbedded.nupkg') }}
          restore-keys: ${{ runner.os }}-nuget-

      - uses: jdx/mise-action@v3
        with:
          install_args: "dotnet"

      - name: Build C# package
        run: dotnet build csharp/SpiceDbEmbedded.sln -c Release

      - name: Build NuGet package
        working-directory: csharp
        run: dotnet pack -c Release

      # Get a short-lived NuGet API key
      - name: NuGet login (OIDC â†’ temp API key)
        uses: NuGet/login@v1
        id: login
        with:
          user: ${{ vars.NUGET_USER }}

      # Push the package
      - name: NuGet push
        working-directory: csharp
        run: dotnet nuget push bin/Release/SpiceDbEmbedded.nupkg --api-key ${{steps.login.outputs.NUGET_API_KEY}} --source https://api.nuget.org/v3/index.json

  # Build platform-specific wheels with bundled native lib (one job per OS).
  build-python-wheels:
    needs: [build-shared-libs]
    defaults:
      run:
        shell: bash
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-latest
            artifact_rid: linux-x64
            natives_key: linux-x64
          - runner: macos-latest
            artifact_rid: osx-arm64
            natives_key: darwin-arm64
          - runner: windows-latest
            artifact_rid: win-x64
            natives_key: win32-x64
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.version || github.ref }}
          fetch-depth: 0

      - name: Download shared lib for this platform
        uses: actions/download-artifact@v4
        with:
          name: shared-lib-${{ matrix.artifact_rid }}

      - name: Stage native lib into package
        run: |
          mkdir -p python/src/spicedb_embedded/natives/${{ matrix.natives_key }}
          cp ${{ matrix.artifact_rid }}/native/* python/src/spicedb_embedded/natives/${{ matrix.natives_key }}/
          ls -R python/src/spicedb_embedded/natives

      - uses: jdx/mise-action@v3
        with:
          install_args: "python"

      - name: Build Python package
        working-directory: python
        run: pip install -e .

      - name: Build wheel
        working-directory: python
        run: pip install build && python -m build --wheel

      - name: Build sdist (Linux only)
        if: matrix.runner == 'ubuntu-latest'
        working-directory: python
        run: python -m build --sdist

      - name: Upload wheel
        uses: actions/upload-artifact@v4
        with:
          name: python-wheel-${{ matrix.natives_key }}
          path: python/dist/*.whl

      - name: Upload sdist
        if: matrix.runner == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: python-sdist
          path: python/dist/*.tar.gz

  publish-pypi:
    needs: [build-python-wheels]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.version || github.ref }}
          fetch-depth: 0

      - name: Download all Python artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: python-*
          path: python/dist
          merge-multiple: true

      - name: Publish package distributions to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: python/dist
