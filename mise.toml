# Minimum required mise version
min_version = '2025.9.19'

[tools]
rust = { version = "1.91.1", components = "rustfmt,clippy" }
"cargo:cargo-deny" = "0.19"
"cargo:sccache" = "0.10"

[env]
RUSTC_WRAPPER = "sccache"
taplo = "0.10.0"
"github:knope-dev/knope" = "knope/v0.21.7"
go = "1.23"
node = "22"
python = "3.11"
java = "temurin-17"
maven = "3.9.9"
dotnet = "9.0"

[tasks.check]
description = "Run format checks, lint, and tests for all languages"
depends = ["format-check", "clippy", "cargo-deny", "test"]

# ============================================================================
# SpiceDB shared/c build tasks
# ============================================================================

[tasks.shared-c-build]
description = "Build the SpiceDB C-shared library from Go source (CGO)"
dir = "shared/c"
run = """
CGO_ENABLED=1 go mod tidy
go build -buildmode=c-shared -o libspicedb.$([ "$(uname)" = "Darwin" ] && echo "dylib" || echo "so") .
"""

[tasks.shared-c-rebuild]
description = "Force rebuild the SpiceDB C-shared library"
dir = "shared/c"
run = """
rm -f libspicedb.so libspicedb.dylib libspicedb.h
CGO_ENABLED=1 go mod tidy
go build -buildmode=c-shared -o libspicedb.$([ "$(uname)" = "Darwin" ] && echo "dylib" || echo "so") .
"""

[tasks.change]
run = "knope document-change"

[tasks.format-check]
description = "Verify format for all languages"
depends = [
  "format-check-rust",
  "check-toml-format",
  "format-check-python",
  "format-check-java",
  "format-check-csharp",
  "format-check-node",
]

[tasks.format-check-rust]
description = "Verify Rust format"
run = "cargo fmt --all --check"

[tasks.format-check-python]
description = "Verify Python format"
dir = "python"
run = """
pip install -e ".[dev]" -q
ruff format --check .
"""

[tasks.format-check-java]
description = "Verify Java format"
dir = "java"
run = "mvn spotless:check"

[tasks.format-check-csharp]
description = "Verify C# format"
run = "dotnet format csharp/SpicedbEmbedded.sln --verify-no-changes"

[tasks.format-check-node]
description = "Verify Node.js package format"
dir = "node"
run = "npm ci && npm run format:check"

[tasks.reformat]
description = "Reformat all languages"
depends = [
  "reformat-rust",
  "reformat-toml",
  "reformat-python",
  "reformat-java",
  "reformat-csharp",
  "reformat-node",
]

[tasks.reformat-rust]
description = "Reformat Rust"
run = "cargo fmt --all"

[tasks.reformat-python]
description = "Reformat Python"
dir = "python"
run = """
pip install -e ".[dev]" -q
ruff format .
"""

[tasks.reformat-java]
description = "Reformat Java"
dir = "java"
run = "mvn spotless:apply"

[tasks.reformat-csharp]
description = "Reformat C#"
run = "dotnet format csharp/SpicedbEmbedded.sln"

[tasks.reformat-node]
description = "Reformat Node.js package"
dir = "node"
run = "npm run format"

[tasks.clippy]
run = "cargo clippy --locked --workspace --all-features --all-targets"

[tasks.test]
description = "Run tests for all languages"
depends = ["rust-test", "java-test", "python-test", "csharp-test", "node-test"]

[tasks.docker-test]
description = "Build and run all tests in Docker (uses BuildKit cache for faster rebuilds)"
# Use native platform (omit --platform) for speed—QEMU emulation on ARM is ~5–10x slower.
# For amd64-only testing: docker build --platform linux/amd64 ...
run = "DOCKER_BUILDKIT=1 docker build -t spicedb-embedded-test -f Dockerfile ."

[tasks.rust-test]
description = "Run Rust tests"
run = "cargo test --locked --workspace"

[tasks.cargo-deny]
run = "cargo deny check -c deny.toml"

[tasks.check-toml-format]
description = "Check TOML formatting"
run = "taplo format --check"

[tasks.reformat-toml]
description = "Reformat TOML files"
run = "taplo format"

# ============================================================================
# Java tasks
# ============================================================================

[tasks.java-build]
description = "Build the Java library"
dir = "java"
run = """
mise run shared-c-build
mvn compile
"""

[tasks.java-test]
description = "Build and test the Java library"
dir = "java"
run = """
mise run shared-c-build
mvn test
"""

# ============================================================================
# Python tasks
# ============================================================================

[tasks.python-build]
description = "Build the Python package"
dir = "python"
run = """
mise run shared-c-build
pip install -e .
"""

[tasks.python-test]
description = "Build and test the Python package"
dir = "python"
run = """
mise run shared-c-build
pip install -e ".[dev]"
pytest
"""

# ============================================================================
# C# / .NET tasks
# ============================================================================

[tasks.csharp-build]
description = "Build the C# library"
run = """
mise run shared-c-build
dotnet build csharp/SpicedbEmbedded.sln
"""

[tasks.csharp-test]
description = "Build and test the C# library"
run = """
mise run shared-c-build
dotnet build csharp/SpicedbEmbedded.sln
SPICEDB_LIBRARY_PATH="$PWD/shared/c/libspicedb.$([ \"$(uname)\" = \"Darwin\" ] && echo dylib || echo so)" dotnet test csharp/SpicedbEmbedded.Tests/SpicedbEmbedded.Tests.csproj --no-build
"""

# ============================================================================
# Node.js
# ============================================================================

[tasks.node-build]
description = "Build the Node.js package"
dir = "node"
run = """
mise run shared-c-build
npm ci
npm run build
"""

[tasks.node-test]
description = "Build and test the Node.js package"
dir = "node"
run = """
mise run shared-c-build
npm ci
npm run build
SPICEDB_LIBRARY_PATH="$PWD/../shared/c" npm test
"""
