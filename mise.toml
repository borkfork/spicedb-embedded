# Minimum required mise version
min_version = '2025.9.19'

[tools]
rust = { version = "1.91.1", components = "rustfmt,clippy" }
buf = "1.49"
"github:authzed/spicedb" = { version = "1.49.0", version_prefix = "v" }
"github:EmbarkStudios/cargo-deny" = { version = "0.19.0", version_prefix = "" }
taplo = "0.10.0"
jq = "1.7"
shellcheck = "0.10.0"
shfmt = "3.8.0"
go = "1.25"
node = "22"
python = "3.11"
java = "temurin-17"
maven = "3.9.9"
dotnet = "9.0"

[tasks.check]
description = "Run format checks, lint, ReSharper, and tests for all languages"
depends = ["format-check", "clippy", "cargo-deny", "resharper-check", "test"]

# ============================================================================
# SpiceDB shared/c build tasks
# ============================================================================

[tasks.shared-c-build]
description = "Build the SpiceDB C-shared library from Go source (CGO)"
run = "bash scripts/shared-c-build.sh"

[tasks.shared-c-rebuild]
description = "Force rebuild the SpiceDB C-shared library"
run = "bash scripts/shared-c-rebuild.sh"

[tasks.change]
description = "Update CHANGELOG from conventional commits (requires knope; not available on linux-arm64)"
tools."github:knope-dev/knope" = "knope/v0.21.7"
run = "knope document-change"

[tasks.format-check]
description = "Verify format for all languages"
depends = [
  "format-check-rust",
  "format-check-bash",
  "format-check-toml",
  "format-check-python",
  "format-check-java",
  "format-check-csharp",
  "format-check-node",
]

[tasks.resharper-check]
description = "Run ReSharper InspectCode (C#) and fail if issues found"
run = "dotnet tool restore && dotnet tool run jb -- inspectcode csharp/SpiceDbEmbedded.sln -o=resharper-inspect.sarif && (jq -e '.runs[0].results | length == 0' resharper-inspect.sarif >/dev/null) || (echo 'ReSharper found issues; see resharper-inspect.sarif' && exit 1)"

[tasks.format-check-bash]
description = "Lint and verify Bash script format (check only, no writes)"
run = "shellcheck scripts/*.sh && shfmt -d -s scripts/"

[tasks.format-check-rust]
description = "Verify Rust format"
run = "rustup toolchain install nightly && rustup component add --toolchain nightly rustfmt && cargo +nightly fmt --all --check"

[tasks.format-check-python]
description = "Verify Python format"
dir = "python"
run = "pip install -e \".[dev]\" -q && ruff format --check ."

[tasks.format-check-java]
description = "Verify Java format"
dir = "java"
run = "mvn spotless:check"

[tasks.format-check-csharp]
description = "Verify C# format"
run = "dotnet format csharp/SpiceDbEmbedded.sln --verify-no-changes"

[tasks.format-check-node]
description = "Verify Node.js package format"
dir = "node"
run = "npm ci && npm run format:check"

[tasks.reformat]
description = "Reformat all languages"
depends = [
  "reformat-rust",
  "reformat-bash",
  "reformat-toml",
  "reformat-python",
  "reformat-java",
  "reformat-csharp",
  "reformat-resharper",
  "reformat-node",
]

[tasks.reformat-bash]
description = "Reformat Bash scripts (writes changes)"
run = "shfmt -w -s scripts/"

[tasks.reformat-rust]
description = "Reformat Rust"
run = "rustup toolchain install nightly && rustup component add --toolchain nightly rustfmt && cargo +nightly fmt --all"

[tasks.reformat-python]
description = "Reformat Python"
dir = "python"
run = "pip install -e '.[dev]' -q && ruff format ."

[tasks.reformat-java]
description = "Reformat Java"
dir = "java"
run = "mvn spotless:apply"

[tasks.reformat-csharp]
description = "Reformat C#"
run = "dotnet format csharp/SpiceDbEmbedded.sln"

[tasks.reformat-resharper]
description = "Apply ReSharper CleanupCode (C#); excludes files that trigger ReSharper CLI HTML-injection bug"
run = "dotnet tool restore && dotnet tool run jb -- cleanupcode csharp/SpiceDbEmbedded.sln --profile=\"Built-in: Reformat Code\" --exclude=\"**/EmbeddedSpiceDb.cs;**/SpiceDbException.cs;**/SpiceDbFfi.cs;**/TcpChannel.cs;**/UnixSocketChannel.cs;**/EmbeddedSpiceDbTests.cs\""

[tasks.reformat-node]
description = "Reformat Node.js package"
dir = "node"
run = "npm ci && npm run format"

[tasks.clippy]
description = "Run Clippy linter (main crate only so only current platform's -sys is built)"
run = "cargo clippy -p spicedb-embedded --locked --all-features --all-targets"

[tasks.test]
description = "Run tests for all languages"
depends = ["rust-test", "java-test", "python-test", "csharp-test", "node-test"]

[tasks.docker-test]
description = "Build and run all tests in Docker (uses BuildKit cache for faster rebuilds)"
# Use native platform (omit --platform) for speed—QEMU emulation on ARM is ~5–10x slower.
# For amd64-only testing: docker build --platform linux/amd64 ...
run = "DOCKER_BUILDKIT=1 docker build -t spicedb-embedded-test -f Dockerfile ."

[tasks.rust-test]
description = "Run Rust tests (main crate only so only current platform's -sys is built)"
run = "mise run shared-c-build && bash ./scripts/stage-all-prebuilds.sh && cargo test -p spicedb-embedded --locked"

[tasks.cargo-deny]
description = "Run cargo-deny (license, advisory, ban checks)"
run = "cargo deny check -c deny.toml"

[tasks.publish-dry-run]
description = "Sync shared/c into rust/shared and run cargo publish --dry-run (same as release workflow)"
run = "mkdir -p rust/shared && cp -r shared/c rust/shared/ && git add -f rust/shared/ && cargo publish -p spicedb-embedded --dry-run --allow-dirty; git reset HEAD rust/shared/ 2>/dev/null || true"

[tasks.format-check-toml]
description = "Check TOML formatting"
run = "taplo format --check"

[tasks.reformat-toml]
description = "Reformat TOML files"
run = "taplo format"

# ============================================================================
# Java tasks
# ============================================================================

[tasks.java-build]
description = "Build the Java library"
dir = "java"
run = "mise run shared-c-build && bash ../scripts/stage-all-prebuilds.sh && mvn compile"

[tasks.java-test]
description = "Build and test the Java library"
dir = "java"
run = "mise run shared-c-build && bash ../scripts/stage-all-prebuilds.sh && mvn test"

# ============================================================================
# Python tasks
# ============================================================================

[tasks.python-build]
description = "Build the Python package"
dir = "python"
run = "mise run shared-c-build && bash ../scripts/stage-all-prebuilds.sh && pip install -e ."

[tasks.python-test]
description = "Build and test the Python package"
dir = "python"
run = "mise run shared-c-build && bash ../scripts/stage-all-prebuilds.sh && pip install -e '.[dev]' && pytest"

# ============================================================================
# C# / .NET tasks
# ============================================================================

[tasks.csharp-build]
description = "Build the C# library"
run = "mise run shared-c-build && bash ./scripts/stage-all-prebuilds.sh && dotnet build csharp/SpiceDbEmbedded.sln"

[tasks.csharp-test]
description = "Build and test the C# library"
run = "mise run shared-c-build && bash ./scripts/stage-all-prebuilds.sh && dotnet build csharp/SpiceDbEmbedded.sln && dotnet test csharp/SpiceDbEmbedded.Tests/SpiceDbEmbedded.Tests.csproj --no-build"

# ============================================================================
# Node.js
# ============================================================================

[tasks.node-build]
description = "Build the Node.js package"
dir = "node"
run = "mise run shared-c-build && bash ../scripts/stage-all-prebuilds.sh && npm ci && npm run build"

[tasks.node-test]
description = "Build and test the Node.js package"
dir = "node"
run = "mise run shared-c-build && bash ../scripts/stage-all-prebuilds.sh && npm ci && npm run build && npm test"
